TG-021 — Backend: Structured crop defaults endpoint (YAML → JSON)

Goal
Expose deterministic crop/variety metadata from our YAML seed packs so the Setup Wizard can render parameters without LLM calls.

Scope
- Add route: GET /api/crops/:cropId/:variety/defaults
- Load and parse the YAML seed at: data/rag/crops/<cropId>/<variety>/<variety>.yaml
  • Fallback: data/rag/crops/<cropId>/<variety>.yaml (support both layouts)
- Return JSON (typed via Zod) with only the whitelisted fields below.

Response shape
{
  "cropId": string,
  "variety": string,
  "lang": string,
  "displayName": string | null,
  "overview": string | null,
  "defaults": {
    "environment"?: {
      "temperature_day"?: string,
      "temperature_night"?: string,
      "humidity"?: string,
      "light_hours"?: string
    },
    "irrigation"?: {
      "method"?: string,
      "frequency"?: string,
      "notes"?: string
    },
    "container"?: {
      "volume_liters"?: string,
      "diameter_cm"?: string,
      "depth_cm"?: string
    },
    "operations"?: Record<string, unknown>
  },
  "safety_bounds"?: {
    "temperature_c"?: { "min": number, "max": number },
    "humidity_pct"?: { "min": number, "max": number },
    "light_hours"?: { "min": number, "max": number }
  },
  "stages": Array<{
    "id": string,
    "label"?: string,
    "cues"?: string[],
    "guidance"?: string
  }>
}

Implementation hints
- Files to touch:
  • backend/src/lib/schemas.ts — add Zod types for CropDefaultsResponse.
  • backend/src/services/crops.ts — read/parse YAML, project allowed fields, and apply caching.
  • backend/src/routes/crops.ts — register GET /api/crops/:cropId/:variety/defaults with validation & typed reply.
  • backend/src/app.ts — register the new crops route module.
- Add in-memory cache (Map) keyed by cropId+variety with TTL (env CROP_DEFAULTS_TTL_MS, default 60000).
  • Skip cache when RAG_DEBUG=true to ease authoring.
- Sanitize inputs and forbid path traversal; build absolute paths from a fixed rag root.
- Do not hit the vector store here; this endpoint is purely file-based.

Errors
- 404 when YAML is missing.
- 422 for invalid params (empty cropId/variety, non-word chars).
- 500 for unreadable/invalid YAML (log error via pino, return safe envelope).

Docs
- backend/.env.example: CROP_DEFAULTS_TTL_MS=60000
- backend/README.md: Add section “Crop defaults endpoint” with sample curl and a sample JSON snippet.
- OpenAPI: Document the route and response schema (read-only, no auth beyond existing mock/firebase modes).

Acceptance
- GET /api/crops/chillies/prairie-fire/defaults returns overview, defaults, safety_bounds, and stages populated from YAML.
- Caching reduces a second call to <10ms locally; toggling RAG_DEBUG=true bypasses cache.
- 404 for unknown crop/variety; 422 for bad params; 500 for malformed YAML.
- No leakage of extra YAML keys beyond the whitelist.

Examples
# success
curl -s http://localhost:3000/api/crops/chillies/prairie-fire/defaults | jq

# 404
curl -s http://localhost:3000/api/crops/unknown/x/defaults | jq

Out of scope
- Any LLM/RAG logic, vector store calls, or multi-language content resolution.
- Frontend changes (will be used by Setup Step 2 in a follow-up ticket).
