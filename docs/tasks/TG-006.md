# TG-006 — Backend scaffold (Fastify + TypeScript) with health route

**Goal**  
Bootstrap the backend so it runs locally with a minimal API (`GET /api/health`). Create the folder structure, install dependencies, add configs, and provide skeleton files (no database yet).

> Follow `backend/AGENTS.md`. Keep changes inside `backend/` only.

---

## Scope
- Initialize a TypeScript Fastify project under `backend/`.
- Install required deps & dev-deps (see below).
- Add base configs (`tsconfig.json`, `.env.example`, `package.json` scripts).
- Implement a minimal Fastify server with CORS + Helmet and one route: `GET /api/health` → `{ ok:true, data:{ status:"ok" } }`.
- Provide a simple response envelope helper (`ok`, `errorBody`).

## Out of Scope
- Real database / persistence.
- Auth modes and Firebase admin integration (covered in a later task).
- Additional routes beyond `health` (added in TG-007).

---

## Dependencies
Install inside `backend/`:
```bash
npm i fastify @fastify/cors @fastify/helmet zod pino dotenv
npm i -D typescript tsx tsup @types/node
```

---

## Project layout (create these files/folders)
```
backend/
  src/
    app.ts
    routes/
      health.ts
    lib/
      respond.ts
      schemas.ts
  .env.example
  package.json
  tsconfig.json
  README.md
```

---

## Files to create (skeleton content)

### `package.json` (scripts + module type)
```json
{
  "name": "tiny-greenhouse-backend",
  "type": "module",
  "private": true,
  "scripts": {
    "dev": "tsx watch src/app.ts",
    "build": "tsup src/app.ts --format esm --dts --out-dir dist --clean",
    "typecheck": "tsc --noEmit",
    "start": "node dist/app.js"
  }
}
```

### `tsconfig.json` (strict ESM)
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ES2022",
    "moduleResolution": "Node",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "outDir": "dist",
    "rootDir": "src"
  },
  "include": ["src"]
}
```

### `.env.example`
```
PORT=3000
NODE_ENV=development
CORS_ORIGIN=http://localhost:5173
```

### `src/lib/respond.ts` (response envelope)
```ts
export const ok = <T>(data: T) => ({ ok: true as const, data });
export const errorBody = (code: string, message: string) => ({ ok: false as const, error: { code, message } });
```

### `src/lib/schemas.ts` (Zod schema for health)
```ts
import { z } from 'zod';

export const HealthResponse = z.object({
  ok: z.literal(true),
  data: z.object({ status: z.literal('ok') })
});
export type HealthResponse = { ok: true; data: { status: 'ok' } };
```

### `src/routes/health.ts` (GET /api/health)
```ts
import { FastifyPluginAsync } from 'fastify';
import { HealthResponse } from '../lib/schemas';
import { ok } from '../lib/respond';

const healthRoutes: FastifyPluginAsync = async (app) => {
  app.get('/api/health', {
    schema: { response: { 200: HealthResponse } as any }
  }, async () => {
    return ok({ status: 'ok' as const });
  });
};

export default healthRoutes;
```

### `src/app.ts` (Fastify server)
```ts
import Fastify from 'fastify';
import cors from '@fastify/cors';
import helmet from '@fastify/helmet';
import 'dotenv/config';

export function buildServer() {
  const app = Fastify({ logger: true });

  app.register(cors, { origin: process.env.CORS_ORIGIN ?? true });
  app.register(helmet);

  app.register(import('./routes/health').then(m => m.default));

  return app;
}

const app = buildServer();
const port = Number(process.env.PORT ?? 3000);
app.listen({ port, host: '0.0.0.0' }).catch((err) => {
  app.log.error(err);
  process.exit(1);
});
```

---

## Vite dev proxy (frontend)
Ensure frontend has a dev proxy to the backend:
```ts
// vite.config.ts
server: { proxy: { '/api': { target: 'http://localhost:3000', changeOrigin: true } } }
```

---

## Smoke checks (must pass)
- `npm run dev` (in `backend/`) boots without unhandled rejections.
- `curl http://localhost:3000/api/health` returns:
  ```json
  { "ok": true, "data": { "status": "ok" } }
  ```
- Frontend can fetch `/api/health` through Vite proxy without CORS errors.
- `npm run typecheck` passes.

---

## Notes for agents
- Keep diffs focused; do not format unrelated files.
- Use ESM imports; no `require()`.
- Do not add new deps unless necessary.