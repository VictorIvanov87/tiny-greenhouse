TG-023 — Frontend: Setup Step 3 (Alarms & Preferences) — polished UX + persistence

Goal
Turn the Step 3 skeleton into a functional “Alarms & Preferences” step that:
- Prefills sensible defaults from the crop defaults endpoint
- Validates against safety_bounds (warn, but allow override)
- Persists user choices (backend + Firebase when available)
- Shows a live summary, then proceeds cleanly to Step 4 → Finish

Scope
Route: /setup (existing wizard). Implement Step 3 content with the sections below.

A) Lighting & Timelapse
- Inputs:
  • Light hours per day (number slider 6–20; default from defaults.environment.light_hours, e.g. “12h” → 12).
  • Start hour (0–23). Compute read-only End hour = (Start + Hours) mod 24.
  • Timelapse capture hour (0–23) with info note (“one snapshot daily”).
- Validation:
  • Warn when hours < bounds.light_hours.min or > max (if bounds absent, warn when <10 or >18).
- UI:
  • Compact helper text: “Seedlings typically want more light hours than fruiting.”

B) Climate thresholds
- Inputs:
  • Target day temperature (°C) and night temperature (°C).
  • Target humidity (%).
- Defaults:
  • From defaults.environment temperature_day/night & humidity (coerce numeric).
- Validation:
  • Compare against safety_bounds.temperature_c and humidity_pct. Show inline Alert when outside bounds.

C) Soil moisture alerts
- Inputs:
  • Alert when soil moisture drops below X% (slider 20–60, step 1; default 40).
  • (Optional) Irrigation hint text from defaults.irrigation (method/frequency) as read-only.
- Note: This is an alert only (no automation in this ticket).

D) Notifications
- Inputs:
  • Channels: email (toggle), push (toggle; can be disabled as “coming soon”).
  • Delivery: immediate (toggle) and/or daily digest at HH:MM (time input; default 09:00).
  • Quiet hours (optional): start/end (HH:MM).

E) Live summary
- A right-side card summarizing the chosen values; updates as the user tweaks inputs.

Data & Persistence
- Wizard state: `src/features/setup/state.ts` (extend with a typed Step3 slice). Persist to localStorage key `tg-setup-v1`.
- Backend:
  • On “Next/Finish”, call `PUT /api/notifications` with a typed payload:
    {
      "light": { "hours": number, "startHour": number },
      "climate": { "temperature": { "day": number, "night": number }, "humidity": { "target": number } },
      "soil": { "moistureLowPct": number },
      "timelapse": { "enabled": true, "hour": number },
      "channels": { "email": boolean, "push": boolean, "digestDaily": boolean },
      "digestHour": number,       // 0–23, used when digestDaily=true
      "quietHours": { "start": string, "end": string } | null  // “22:00”..“07:00”
    }
  • If `/api/notifications` is not available, keep local state and show a non-blocking banner “Notifications not connected (saved locally)”. Do not block finishing the wizard.
- Firebase (optional): write `users/{uid}/notifications` with the same shape.

Deriving defaults
- Fetch `/api/crops/:cropId/:variety/defaults` from Step 2 (available in state).
- Helpers:
  • `parseHours(input: string): number` — supports “12h”, “14–16h” (return the lower bound).
  • `coerceNumber(input: string | number): number | null` — parse “24°C” → 24.
  • `isWithinBounds(value: number, bounds?: {min:number,max:number}): boolean`.
- Initial values:
  • light.hours ← parseHours(defaults.environment.light_hours) || 12
  • climate.temperature.day ← coerceNumber(defaults.environment.temperature_day) || 24
  • climate.temperature.night ← coerceNumber(defaults.environment.temperature_night) || 18
  • climate.humidity.target ← coerceNumber(defaults.environment.humidity) || 60
  • soil.moistureLowPct ← 40
  • startHour ← 8, timelapse.hour ← 9

UX/Components (Flowbite React)
- Use Card, ListGroup, Range slider, NumberInput (or Input + stepper), Badge, Alert, Button, and Toggle.
- Keep the wizard header sticky; entire step should be scrollable within content area.
- Display safety bounds as subtle badges near inputs (e.g., “Safe: 18–26°C”).

Error handling
- Network errors on defaults → retry button.
- Persist failures on PUT → toast + remain on Step 3; user may retry or continue (since we keep local state).

Files to touch
- `src/features/setup/SetupWizard.tsx` (Step 3 content)
- `src/features/setup/state.ts` (Step3 slice + (de)serialization)
- `src/features/setup/api.ts` (add `putNotifications()` if not present)
- `src/shared/utils/formatters.ts` (parsers/coercers as above)
- `src/shared/ui/*` (small wrappers if needed)

Acceptance
- Selecting a variety in Step 2 pre-fills Step 3 fields from defaults; entering out-of-bounds values shows warnings but allows “Next”.
- Clicking “Finish”:
  • Calls `PUT /api/notifications` (if available) and saves to Firebase (if configured).
  • Updates wizard state to “complete” and redirects to /dashboard.
  • Sidebar hides “Setup Wizard” for configured users.
- Refreshing after finish lands on /dashboard (not /setup).

Out of scope
- Real device control, scheduling engine, or background jobs.
- Multi-language copy and i18n (English only for now).
