# TG-017 — Setup Wizard skeleton (fullscreen stepper, flow only)

**Goal**  
Implement a **fullscreen** Setup Wizard with a stepper and basic navigation (Next/Back/Cancel/Finish). No business logic/content yet — just the skeleton, validation gating per step, local state with **localStorage** persistence, and redirect to `/dashboard` on completion. Use Flowbite + Tailwind only.

> Follow `frontend/AGENTS.md` (Flowbite-first UI, full-height layout, responsive). Keep diffs small and scoped to the setup feature.

---

## Steps (placeholders only)
1) **Welcome** — intro text + Continue.
2) **Crop** — pick a crop and a variety (3 placeholder options total; only Chillies → Variety X needs to be selectable for now).
3) **Prefs** — alarms & defaults (fields present but non-functional; just stub inputs and validation).
4) **Review** — summary screen with a **Finish** button.

**Rules**
- The **Next** button is disabled until the current step is valid.
- Persist wizard state in `localStorage` so reload keeps progress (`key: tg.setup.v1`).
- **Cancel/Close** confirms and returns to `/dashboard` (does not save).
- **Finish** simulates save:
  - Call `PUT /api/greenhouses/current` with a minimal payload derived from the wizard (id/name/method/plantType/language/timelapse from defaults).
  - On success: set `hasSetup=true` **in localStorage** (for now) and redirect to `/dashboard`.

_No real content, no RAG calls — just structure and flow._

---

## File changes
```
src/
  features/
    setup/
      wizard/
        SetupWizard.tsx        # NEW — shell, step router, footer actions
        Stepper.tsx            # NEW — visual stepper (top)
        steps/
          StepWelcome.tsx      # NEW — placeholder
          StepCrop.tsx         # NEW — placeholder (with dummy options)
          StepPrefs.tsx        # NEW — placeholder (stub inputs)
          StepReview.tsx       # NEW — placeholder (read-only summary)
        state.ts               # NEW — types, localStorage load/save, validation helpers
  app/routes.tsx               # UPDATE — render <SetupWizard /> at /setup
  features/settings/SettingsPage.tsx  # (optional) add “Restart setup” button → /setup
```

---

## Types & State (sketch)

```ts
// state.ts
export type WizardStep = 0 | 1 | 2 | 3;

export type CropKind = 'chillies' | 'lettuce' | 'strawberries';
export type Variety = 'placeholderA' | 'placeholderB' | 'placeholderC'; // use any 3; only one valid path is required now

export interface SetupData {
  step: WizardStep;
  crop?: { kind?: CropKind; variety?: Variety };
  prefs?: {
    lightHours?: number;        // 1..24 (default 12)
    soilMoistureLow?: number;   // 0..100 (default 30)
    tempHigh?: number;          // °C (default 30)
    timelapseHour?: number;     // 0..23 (default 9)
    language?: 'en' | 'bg';
    method?: 'soil' | 'nft' | 'dwc'; // default 'soil'
  };
}

const KEY = 'tg.setup.v1';

export function load(): SetupData {
  try { return JSON.parse(localStorage.getItem(KEY) || '{}'); } catch { return {}; }
}
export function save(s: SetupData) { localStorage.setItem(KEY, JSON.stringify(s)); }
export function reset() { localStorage.removeItem(KEY); }

export function isStepValid(s: SetupData, step: WizardStep): boolean {
  switch (step) {
    case 0: return true; // welcome
    case 1: return !!(s.crop?.kind && s.crop?.variety);
    case 2: {
      const p = s.prefs || {};
      const ok =
        typeof p.lightHours === 'number' && p.lightHours >= 1 && p.lightHours <= 24 &&
        typeof p.soilMoistureLow === 'number' && p.soilMoistureLow >= 0 && p.soilMoistureLow <= 100 &&
        typeof p.tempHigh === 'number' && p.tempHigh >= 5 && p.tempHigh <= 45 &&
        typeof p.timelapseHour === 'number' && p.timelapseHour >= 0 && p.timelapseHour <= 23;
      return ok;
    }
    case 3: return true; // review
  }
}
```

---

## Setup shell & stepper (sketch)

```tsx
// SetupWizard.tsx
import { useEffect, useState } from 'react';
import { Button, Card } from 'flowbite-react';
import { load, save, reset, isStepValid, type SetupData } from './state';
import { Stepper } from './Stepper';
import StepWelcome from './steps/StepWelcome';
import StepCrop from './steps/StepCrop';
import StepPrefs from './steps/StepPrefs';
import StepReview from './steps/StepReview';
import { updateCurrentGreenhouse } from '@/features/greenhouse/api';

const TITLES = ['Welcome', 'Choose crop', 'Alarms & settings', 'Review'];

export default function SetupWizard() {
  const [data, setData] = useState<SetupData>(() => ({
    step: 0,
    prefs: { lightHours: 12, soilMoistureLow: 30, tempHigh: 30, timelapseHour: 9, method: 'soil', language: 'en' },
    ...load(),
  } as SetupData));

  useEffect(() => { save(data); }, [data]);

  const step = data.step ?? 0;
  const canNext = isStepValid(data, step);
  const atLast = step === 3;

  function next() { if (!canNext) return; setData(d => ({ ...d, step: Math.min(3, (d.step ?? 0) + 1) })); }
  function back() { setData(d => ({ ...d, step: Math.max(0, (d.step ?? 0) - 1) })); }
  function cancel() { /* confirm */ window.location.assign('/dashboard'); }

  async function finish() {
    // Minimal payload; later will include full mapping from prefs/crop
    await updateCurrentGreenhouse({
      id: 'default',
      name: 'Tiny Greenhouse',
      method: data.prefs?.method ?? 'soil',
      plantType: data.crop?.kind ?? 'chillies',
      language: data.prefs?.language ?? 'en',
      timelapse: { enabled: true, hour: data.prefs?.timelapseHour ?? 9 },
    } as any);
    localStorage.setItem('tg.hasSetup', 'true');
    reset();
    window.location.assign('/dashboard');
  }

  return (
    <div className="fixed inset-0 bg-gray-900/60 backdrop-blur-sm">
      <div className="min-h-screen flex flex-col">
        {/* Top bar */}
        <div className="px-4 py-3 bg-white/90 shadow">
          <div className="max-w-5xl mx-auto">
            <Stepper current={step} titles={TITLES} />
          </div>
        </div>

        {/* Content */}
        <main className="flex-1 flex items-center justify-center px-4">
          <Card className="w-full max-w-5xl">
            {step === 0 && <StepWelcome data={data} onChange={setData} />}
            {step === 1 && <StepCrop data={data} onChange={setData} />}
            {step === 2 && <StepPrefs data={data} onChange={setData} />}
            {step === 3 && <StepReview data={data} />}
            <div className="mt-6 flex items-center justify-between">
              <div className="text-sm text-gray-500">Step {step + 1} of 4</div>
              <div className="flex gap-2">
                <Button color="light" onClick={cancel}>Cancel</Button>
                <Button color="light" onClick={back} disabled={step === 0}>Back</Button>
                {!atLast ? (
                  <Button onClick={next} disabled={!canNext}>Next</Button>
                ) : (
                  <Button onClick={finish}>Finish</Button>
                )}
              </div>
            </div>
          </Card>
        </main>
      </div>
    </div>
  );
}
```

```tsx
// Stepper.tsx
import { Badge } from 'flowbite-react';

export function Stepper({ current, titles }: { current: number; titles: string[] }) {
  return (
    <div className="flex items-center justify-between">
      {titles.map((t, i) => (
        <div key={t} className="flex-1 flex items-center gap-2">
          <Badge color={i < current ? 'success' : i === current ? 'info' : 'gray'}>{i + 1}</Badge>
          <div className={i === current ? 'font-medium' : 'text-gray-500'}>{t}</div>
          {i < titles.length - 1 && <div className="h-px flex-1 bg-gray-200 mx-2" />}
        </div>
      ))}
    </div>
  );
}
export default Stepper;
```

```tsx
// steps/StepWelcome.tsx (placeholder)
import type { SetupData } from '../state';
export default function StepWelcome({ data, onChange }: { data: SetupData; onChange: (u: SetupData) => void }) {
  return (
    <div className="space-y-2">
      <h2 className="text-xl font-semibold">Welcome to Tiny Greenhouse</h2>
      <p className="text-gray-600">This wizard will guide you through the initial setup.</p>
    </div>
  );
}
```

```tsx
// steps/StepCrop.tsx (placeholder with dummy options)
import { Label, Radio, Select } from 'flowbite-react';
import type { SetupData, CropKind, Variety } from '../state';

const kinds: CropKind[] = ['chillies','lettuce','strawberries'];
const varieties: Variety[] = ['placeholderA','placeholderB','placeholderC'];

export default function StepCrop({ data, onChange }: { data: SetupData; onChange: (u: SetupData) => void }) {
  const crop = data.crop || {};
  return (
    <div className="space-y-4">
      <div className="space-y-2">
        <div className="font-medium">Choose crop</div>
        <div className="flex gap-4">
          {kinds.map(k => (
            <label key={k} className="flex items-center gap-2 cursor-pointer">
              <Radio name="kind" checked={crop.kind === k} onChange={() => onChange({ ...data, crop: { ...crop, kind: k } })} />
              <span className="capitalize">{k}</span>
            </label>
          ))}
        </div>
      </div>
      <div>
        <Label htmlFor="var" value="Variety" />
        <Select id="var" value={crop.variety || ''} onChange={(e) => onChange({ ...data, crop: { ...crop, variety: e.target.value as Variety } })}>
          <option value="" disabled>Select variety</option>
          {varieties.map(v => <option key={v} value={v}>{v}</option>)}
        </Select>
      </div>
    </div>
  );
}
```

```tsx
// steps/StepPrefs.tsx (stub inputs)
import { Label, TextInput } from 'flowbite-react';
import type { SetupData } from '../state';

export default function StepPrefs({ data, onChange }: { data: SetupData; onChange: (u: SetupData) => void }) {
  const p = data.prefs || {};
  function set(k, v) {
    onChange({ ...data, prefs: { ...p, [k]: v } });
  }
  return (
    <div className="grid gap-4 md:grid-cols-2">
      <div>
        <Label htmlFor="lh" value="Light hours per day (1..24)" />
        <TextInput id="lh" type="number" min={1} max={24} value={p.lightHours ?? 12} onChange={(e) => set('lightHours', Number(e.target.value) || 12)} />
      </div>
      <div>
        <Label htmlFor="sm" value="Soil moisture low threshold (0..100)" />
        <TextInput id="sm" type="number" min={0} max={100} value={p.soilMoistureLow ?? 30} onChange={(e) => set('soilMoistureLow', Number(e.target.value) || 30)} />
      </div>
      <div>
        <Label htmlFor="th" value="Temperature high (°C, 5..45)" />
        <TextInput id="th" type="number" min={5} max={45} value={p.tempHigh ?? 30} onChange={(e) => set('tempHigh', Number(e.target.value) || 30)} />
      </div>
      <div>
        <Label htmlFor="tl" value="Timelapse hour (0..23)" />
        <TextInput id="tl" type="number" min={0} max={23} value={p.timelapseHour ?? 9} onChange={(e) => set('timelapseHour', Number(e.target.value) || 9)} />
      </div>
    </div>
  );
}
```

```tsx
// steps/StepReview.tsx (placeholder summary)
import type { SetupData } from '../state';

export default function StepReview({ data }: { data: SetupData }) {
  return (
    <div className="space-y-2 text-sm">
      <div><span className="text-gray-500">Crop:</span> {data.crop?.kind} / {data.crop?.variety}</div>
      <div><span className="text-gray-500">Light hours:</span> {data.prefs?.lightHours}</div>
      <div><span className="text-gray-500">Soil moisture low:</span> {data.prefs?.soilMoistureLow}%</div>
      <div><span className="text-gray-500">Temp high:</span> {data.prefs?.tempHigh}°C</div>
      <div><span className="text-gray-500">Timelapse hour:</span> {data.prefs?.timelapseHour}:00</div>
    </div>
  );
}
```

---

## Router & Guards
- Ensure `/setup` renders `SetupWizard`. If you already gate routes by `hasSetup`, keep current logic. For demo, we set `localStorage['tg.hasSetup']='true'` on **Finish**.
- Sidebar should **not** show Setup once done (optional).

---

## Acceptance
- Visiting `/setup` shows a **fullscreen** wizard with a **top stepper**.
- Four placeholder steps render; **Next** is disabled until each step is valid (Crop requires kind+variety; Prefs requires numeric ranges).
- State persists across reloads via `localStorage`.
- **Finish** performs `PUT /api/greenhouses/current` with a minimal payload and then redirects to `/dashboard`. Also sets `localStorage['tg.hasSetup'] = 'true'`.
- No new dependencies; Flowbite + Tailwind only. All changes are scoped to `features/setup/wizard` (+ route wiring).
