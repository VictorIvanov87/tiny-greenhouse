# TG-009 — Wire Dashboard to `/api/telemetry` (frontend)

**Goal**  
Connect the Dashboard to the backend mock endpoint and render recent telemetry. Keep it simple: fetch, show loading/error states, a table, and a couple of summary cards.

> Follow `frontend/AGENTS.md` (Flowbite-first UI, Tailwind layout). No new runtime deps.

---

## Scope

-   Add a small API module under `src/features/telemetry/api.ts`:
    -   `getTelemetry({ limit = 25, from?, to?, sensor? })` → calls `/api/telemetry` and returns `{ items, total }`.
    -   Define TS types that mirror the backend Zod schemas.
-   Update `DashboardPage.tsx` to fetch the last N samples on mount (e.g., `limit=25`).
-   UI:
    -   **Loading:** Flowbite `Spinner` centered.
    -   **Error:** Flowbite `Alert` with retry button.
    -   **Success:** Flowbite `Card` with 2–3 KPIs (avg temperature, avg humidity, latest soil moisture), and a Flowbite `Table` listing samples.
-   Respect layout rules: full-height shell, responsive without horizontal scroll.

---

## File changes (frontend)

```
src/
  features/
    telemetry/
      api.ts            # new
  features/dashboard/
    DashboardPage.tsx   # update to call api and render UI
  shared/hooks/
    useApi.ts           # ensure baseURL '/api' and (optionally) Firebase token
```

### `src/features/telemetry/api.ts` (sketch)

```ts
import { api } from "@/shared/hooks/useApi";

export type TelemetrySample = {
	timestamp: string; // ISO
	temperature: number;
	humidity: number;
	soilMoisture: number;
	lightHours?: number;
	sensor?: string;
};
export type TelemetryList = { items: TelemetrySample[]; total: number };

export async function getTelemetry(
	params: {
		limit?: number;
		from?: string;
		to?: string;
		sensor?: string;
	} = {}
): Promise<TelemetryList> {
	const { data } = await api.get("/telemetry", { params });
	// backend envelope: { ok, data }
	if (!data?.ok) throw new Error("Telemetry request failed");
	return data.data as TelemetryList;
}
```

### `src/features/dashboard/DashboardPage.tsx` (sketch)

```tsx
import { useEffect, useMemo, useState } from "react";
import { Card, Spinner, Alert, Table } from "flowbite-react";
import { getTelemetry, TelemetrySample } from "@/features/telemetry/api";

export default function DashboardPage() {
	const [items, setItems] = useState<TelemetrySample[] | null>(null);
	const [error, setError] = useState<string | null>(null);
	const [loading, setLoading] = useState(true);

	useEffect(() => {
		let mounted = true;
		setLoading(true);
		getTelemetry({ limit: 25 })
			.then((res) => {
				if (mounted) {
					setItems(res.items);
					setError(null);
				}
			})
			.catch((e) => {
				if (mounted) setError(e.message || "Failed to load telemetry");
			})
			.finally(() => {
				if (mounted) setLoading(false);
			});
		return () => {
			mounted = false;
		};
	}, []);

	const kpi = useMemo(() => {
		if (!items || items.length === 0) return null;
		const avg = (arr: number[]) =>
			(arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1);
		return {
			avgTemp: avg(items.map((i) => i.temperature)),
			avgHum: avg(items.map((i) => i.humidity)),
			latestSoil: items[items.length - 1]?.soilMoisture?.toFixed(1),
		};
	}, [items]);

	if (loading)
		return (
			<div className="min-h-[60vh] flex items-center justify-center">
				<Spinner size="xl" />
			</div>
		);

	if (error)
		return (
			<div className="p-4">
				<Alert color="failure" onDismiss={() => setError(null)}>
					<span className="font-medium">Error:</span> {error}
				</Alert>
				<button
					className="mt-3 px-3 py-2 rounded bg-emerald-600 text-white"
					onClick={() => window.location.reload()}
				>
					Retry
				</button>
			</div>
		);

	return (
		<div className="p-4 space-y-4">
			<div className="grid grid-cols-1 md:grid-cols-3 gap-4">
				<Card>
					<div className="text-sm text-gray-500">Avg Temperature</div>
					<div className="text-2xl font-semibold">
						{kpi?.avgTemp ?? "—"} °C
					</div>
				</Card>
				<Card>
					<div className="text-sm text-gray-500">Avg Humidity</div>
					<div className="text-2xl font-semibold">
						{kpi?.avgHum ?? "—"} %
					</div>
				</Card>
				<Card>
					<div className="text-sm text-gray-500">
						Latest Soil Moisture
					</div>
					<div className="text-2xl font-semibold">
						{kpi?.latestSoil ?? "—"} %
					</div>
				</Card>
			</div>

			<Card>
				<div className="mb-3 text-lg font-semibold">
					Recent telemetry
				</div>
				<Table>
					<Table.Head>
						<Table.HeadCell>Time</Table.HeadCell>
						<Table.HeadCell>Temp (°C)</Table.HeadCell>
						<Table.HeadCell>Humidity (%)</Table.HeadCell>
						<Table.HeadCell>Soil Moisture (%)</Table.HeadCell>
					</Table.Head>
					<Table.Body className="divide-y">
						{(items ?? []).map((i) => (
							<Table.Row key={i.timestamp}>
								<Table.Cell>
									{new Date(i.timestamp).toLocaleString()}
								</Table.Cell>
								<Table.Cell>
									{i.temperature.toFixed(1)}
								</Table.Cell>
								<Table.Cell>{i.humidity.toFixed(1)}</Table.Cell>
								<Table.Cell>
									{i.soilMoisture.toFixed(1)}
								</Table.Cell>
							</Table.Row>
						))}
					</Table.Body>
				</Table>
			</Card>
		</div>
	);
}
```

---

## Acceptance

-   On `/dashboard`, the app fetches `/api/telemetry?limit=25` on mount.
-   Loading spinner shows until data arrives; network errors show an Alert.
-   Three KPI cards display averages/latest (computed from the received items).
-   A Flowbite Table lists the samples with formatted timestamps.
-   No horizontal scroll at sm/md/lg; layout adheres to `min-h-screen` page shell.

---

## Notes for agents

-   Use Flowbite React components where possible; keep custom CSS to Tailwind utility classes.
-   Do not introduce new runtime dependencies. If charts are needed later, we’ll add them explicitly in a separate task.
-   Keep diffs small and constrained to `features/telemetry` and `features/dashboard`.
