# TG-003 — Setup Wizard + Route Guard (Firestore-backed)

**Goal**  
Implement a **first-run Setup Wizard** and a **route guard** that sends users to `/setup` until their profile shows `setupCompleted: true`; otherwise they see `/dashboard`.

> Follow `frontend/AGENTS.md` (layout/structure). Keep changes in the frontend. Use Firebase **Firestore** for user setup data.

---

## Scope
- Detect user profile after Firebase Auth sign-in:
  - Read `users/{uid}` from Firestore.
  - If missing, create a minimal doc with `setupCompleted: false`.
- If `setupCompleted === false`, redirect to `/setup`.
- Wizard steps (UI only, but **persist** final settings to Firestore):
  1. **Language** (bg/en).
  2. **Plant type** (e.g., `basket-of-fire`, `prairie-fire`, `reaper`, `mushroom-kit`).
  3. **Notifications** (email/push placeholders).
  4. **Review & Confirm** (persist + mark `setupCompleted: true`).
- Create/update `users/{uid}` with:
  ```json
  {
    "setupCompleted": true|false,
    "language": "bg" | "en",
    "plantType": "basket-of-fire" | "...",
    "notifications": { "email": true, "push": false },
    "currentGreenhouseId": "gh_<id>"
  }
  ```
- Optionally create a first greenhouse doc under `greenhouses/{id}` with `ownerUid` and `method` (soil/nft/dwc).

## Out of Scope
- Real notification sending, backend services, i18n framework.  
- Multi-user roles/permissions, complex validation.

---

## Dependencies
Already present: `firebase`. Ensure Firestore imports are from the **modular SDK** (`import { getFirestore, doc, getDoc, setDoc } from 'firebase/firestore'`).

---

## Files to Create/Modify (suggested)
- `src/features/setup/SetupPage.tsx` — page container mounted at `/setup`.
- `src/features/setup/components/SetupWizard.tsx` — the stepper + forms.
- `src/features/setup/state.ts` — local state + (optional) zod schema for wizard data.
- `src/features/setup/api.ts` — Firestore helpers:
  - `getUserProfile(uid)` → returns profile or `null`.
  - `ensureUserDoc(uid)` → create minimal doc `{ setupCompleted:false }` if missing.
  - `completeSetup(uid, data)` → write fields and set `setupCompleted:true`.
- `src/features/auth/auth-context.tsx` — already exists (TG-002). Expose `{ user, loading }`.
- `src/app/routes.tsx` — **guard** logic:
  - If `!user` → `/login`.
  - If `user` and `setupCompleted === false` → `/setup`.
  - Else → `/dashboard`.
- `src/shared/ui/Stepper.tsx` — (optional) minimal stepper UI using Flowbite + Tailwind.

---

## UX Requirements
- `/setup` is **publicly reachable**, but if user is logged out, redirect to `/login` before rendering steps.
- Wizard shows step titles and progress; Next/Back buttons; Finish button on last step.
- Disable **Finish** until required fields are selected (language, plant type).
- On Finish: persist to Firestore → navigate to `/dashboard`.
- Mobile-friendly; center the card; max width ~`max-w-lg`.

---

## Steps (Execution Plan)
1. **Profile read:** after Auth state is ready, read `users/{uid}`. If empty → `ensureUserDoc(uid)` with `setupCompleted:false`.
2. **Guard:** implement a small `useUserProfile()` hook (or React Query) so `routes.tsx` can decide to redirect to `/setup` or `/dashboard`.
3. **Wizard UI:** build 4 steps with Flowbite (Card + Inputs + Buttons). Persist to local state.
4. **Persist:** implement `completeSetup(uid, data)` → sets `setupCompleted:true` and optional `greenhouses/{id}` scaffold.
5. **Navigate:** after success, `navigate('/dashboard')`.
6. **Smoke checks** below.

---

## Smoke Checks (must pass)
- Signed-in user without profile → `/setup` with minimal doc auto-created.
- Signed-in user with `setupCompleted:false` → `/setup`.
- Completing the wizard writes user doc and redirects to `/dashboard`.
- Refresh preserves auth and guard behavior.
- Mobile view has no horizontal scroll; forms are usable.

---

## Notes for Agents
- Keep diffs focused; do not reformat unrelated files.
- Use Flowbite React components. Tailwind for layout only.
- Place Firestore helpers in `src/features/setup/api.ts`. Type results.
