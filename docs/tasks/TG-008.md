# TG-008 — Auth layer (mock | Firebase) + per-user scoping

**Goal**  
Add an authentication pre-handler to the backend that supports two modes — `mock` and `firebase` — and scope protected endpoints by `uid`. In `mock` mode the server trusts a synthetic user; in `firebase` mode it validates a Firebase ID token and extracts the real `uid`. Use in-memory maps keyed by `uid` for state (no DB yet).

> Keep changes inside `backend/` only. Follow `backend/AGENTS.md` conventions.

---

## Scope

- Install and wire **Firebase Admin** for token verification (when `AUTH_MODE=firebase`).
- Create **auth plugin** that decorates Fastify with `app.auth` (a preHandler).
- Protect selected routes with `preHandler: app.auth` and scope data to `req.user.uid`.
- Maintain simple **in-memory** stores per `uid` for `notifications` and `greenhouse` (mock).
- Update `.env.example` with auth-related variables.
- Update `backend/AGENTS.md` with a short “Protected routes” recipe.

**Protected now:** `/api/notifications` (GET/PUT), `/api/greenhouses/current` (GET/PUT).  
**Public:** `/api/health`, `/api/timelapse` (can be switched later).  
**Optional:** protect `/api/telemetry` in a follow-up once per-user data is ready.

---

## Dependencies

Inside `backend/`:

```bash
npm i firebase-admin
# optional (nice-to-have):
npm i @fastify/rate-limit
```

---

## ENV (`.env.example` additions)

```
AUTH_MODE=mock                # mock | firebase
# Firebase Admin (only required when AUTH_MODE=firebase)
FIREBASE_PROJECT_ID=
FIREBASE_CLIENT_EMAIL=
FIREBASE_PRIVATE_KEY=         # Use \n for newlines if stored on one line
```

> Ensure `dotenv` is loaded (already done in TG-006 `app.ts`: `import 'dotenv/config'`).

---

## File changes / additions

```
backend/
  src/
    plugins/
      auth.ts            # NEW — registers app.auth preHandler (mock|firebase)
    lib/
      firebase.ts        # NEW — lazy init of firebase-admin from ENV
    routes/
      greenhouse.ts      # UPDATE — add PUT and preHandler: app.auth
      notifications.ts   # UPDATE — add preHandler: app.auth
    types/
      fastify.d.ts       # NEW — TypeScript module augmentation for req.user/app.auth
  .env.example           # UPDATE — add AUTH_MODE and Firebase vars
  AGENTS.md              # UPDATE — short recipe for protected routes
```

---

## TypeScript augmentation (`src/types/fastify.d.ts`)

```ts
import 'fastify';

declare module 'fastify' {
  interface FastifyRequest {
    user?: { uid: string; email?: string };
  }
  interface FastifyInstance {
    auth: (req: FastifyRequest, reply: FastifyReply) => Promise<void>;
  }
}
```

> Make sure `tsconfig.json` includes `"include": ["src"]` (already done), and this file lives under `src/`.

---

## Firebase Admin init (`src/lib/firebase.ts`)

```ts
import { initializeApp, getApps, cert, App } from 'firebase-admin/app';
import { getAuth } from 'firebase-admin/auth';

let app: App | null = null;

export function ensureFirebase() {
  if (!app) {
    const projectId = process.env.FIREBASE_PROJECT_ID;
    const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;
    let privateKey = process.env.FIREBASE_PRIVATE_KEY;
    if (!projectId || !clientEmail || !privateKey) {
      throw new Error('Missing Firebase Admin credentials in ENV');
    }
    // Replace escaped newlines if provided on one line
    privateKey = privateKey.replace(/\\n/g, '\n');
    app = initializeApp({ credential: cert({ projectId, clientEmail, privateKey }) });
  }
  return { auth: getAuth() };
}
```

---

## Auth plugin (`src/plugins/auth.ts`)

```ts
import { FastifyPluginAsync } from 'fastify';
import fp from 'fastify-plugin';
import { ensureFirebase } from '../lib/firebase';

const authPlugin: FastifyPluginAsync = async (app) => {
  const mode = (process.env.AUTH_MODE ?? 'mock').toLowerCase();

  async function preHandler(req: any, reply: any) {
    if (mode === 'mock') {
      // Synthetic user for local dev
      const uid = (req.headers['x-user-id'] as string) || 'demo';
      req.user = { uid };
      return;
    }
    // firebase mode
    const header = req.headers.authorization || '';
    const [, token] = header.split(' ');
    if (!token) {
      reply.code(401).send({ ok: false, error: { code: 'unauthorized', message: 'Missing token' } });
      return;
    }
    try {
      const { auth } = ensureFirebase();
      const decoded = await auth.verifyIdToken(token);
      req.user = { uid: decoded.uid, email: decoded.email };
    } catch (err: any) {
      req.log.warn({ err }, 'Invalid ID token');
      reply.code(401).send({ ok: false, error: { code: 'unauthorized', message: 'Invalid token' } });
    }
  }

  app.decorate('auth', preHandler);
};

export default fp(authPlugin);
```

---

## Route updates — per-user scoping

### `routes/notifications.ts`

```ts
import { FastifyPluginAsync } from 'fastify';
import { NotificationPrefs } from '../lib/schemas';
import { ok } from '../lib/respond';
import { readMock } from '../lib/file';

const cache: Record<string, any> = {};

const notificationRoutes: FastifyPluginAsync = async (app) => {
  app.get('/api/notifications', {
    preHandler: app.auth,
    schema: { response: { 200: NotificationPrefs } as any }
  }, async (req) => {
    const uid = req.user!.uid;
    if (!cache[uid]) {
      cache[uid] = await readMock('notifications.json');
    }
    return ok(cache[uid]);
  });

  app.put('/api/notifications', {
    preHandler: app.auth,
    schema: { body: NotificationPrefs as any, response: { 200: NotificationPrefs } as any }
  }, async (req) => {
    const uid = req.user!.uid;
    cache[uid] = req.body;
    return ok(cache[uid]);
  });
};

export default notificationRoutes;
```

### `routes/greenhouse.ts`

```ts
import { FastifyPluginAsync } from 'fastify';
import { GreenhouseConfig } from '../lib/schemas';
import { ok } from '../lib/respond';
import { readMock } from '../lib/file';

const state: Record<string, any> = {};

const greenhouseRoutes: FastifyPluginAsync = async (app) => {
  app.get('/api/greenhouses/current', {
    preHandler: app.auth,
    schema: { response: { 200: GreenhouseConfig } as any }
  }, async (req) => {
    const uid = req.user!.uid;
    if (!state[uid]) state[uid] = await readMock('greenhouse.json');
    return ok(state[uid]);
  });

  app.put('/api/greenhouses/current', {
    preHandler: app.auth,
    schema: { body: GreenhouseConfig as any, response: { 200: GreenhouseConfig } as any }
  }, async (req) => {
    const uid = req.user!.uid;
    state[uid] = req.body;
    return ok(state[uid]);
  });
};

export default greenhouseRoutes;
```

---

## Wire plugin in the server (`src/app.ts`)

Register the auth plugin **before** protected routes:

```ts
app.register(import('./plugins/auth').then(m => m.default));

// public routes
app.register(import('./routes/health').then(m => m.default));
app.register(import('./routes/timelapse').then(m => m.default));

// protected routes
app.register(import('./routes/notifications').then(m => m.default));
app.register(import('./routes/greenhouse').then(m => m.default));
// optional later: telemetry as protected
```

> If using `@fastify/rate-limit`, register it once near the top:
```ts
// import rateLimit from '@fastify/rate-limit';
// app.register(rateLimit, { max: 100, timeWindow: '1 minute' });
```

---

## Frontend note (thin integration)

The Axios layer should attach the Firebase ID token automatically when a user is logged in:

```ts
// pseudo-code inside frontend src/shared/api/useApi.ts
import axios from 'axios';
import { getAuth } from 'firebase/auth';

const api = axios.create({ baseURL: '/api' });
api.interceptors.request.use(async (config) => {
  const user = getAuth().currentUser;
  if (user) {
    const token = await user.getIdToken();
    config.headers = config.headers ?? {};
    config.headers['Authorization'] = `Bearer ${token}`;
  }
  return config;
});
export default api;
```

No token is needed in `mock` mode, but this interceptor won’t hurt.

---

## Smoke checks

- **mock mode** (`AUTH_MODE=mock`):
  - `GET /api/notifications` returns the default mock for `uid='demo'`.
  - `PUT /api/notifications` updates only the in-memory object for `uid='demo'`.
  - `GET /api/greenhouses/current` works likewise.
- **firebase mode** (`AUTH_MODE=firebase` with valid ENV):
  - Requests **without** `Authorization: Bearer <ID_TOKEN>` → `401` with `{ ok:false, error:{ code:'unauthorized' } }`.
  - With a valid ID token → `200` and `req.user.uid` populated.
- All protected routes add `preHandler: app.auth` and keep the common `{ ok, data }` envelope.
- `npm run typecheck` passes.

---

## Notes for agents

- Do not rewrite unrelated files. Keep diffs small.
- No roles/ACL now; **only `uid` scoping**.
- Store per-user state in memory only (no disk writes).
