# TG-011 — Wire `/api/notifications` (GET/PUT) + UI

**Goal**  
Build a Notifications screen that reads and updates user preferences via the backend mock endpoints. Include basic validation, loading/error states, and a clean Flowbite UI.

> Follow `frontend/AGENTS.md` (Flowbite-first UI, Tailwind layout). No new runtime deps.

---

## Backend contract (already in TG-007/TG-008)
`GET /api/notifications` → `{ ok: true, data: NotificationPrefs }`  
`PUT /api/notifications` (body: NotificationPrefs) → `{ ok: true, data: NotificationPrefs }`

```ts
// Mirror Zod types from backend:
export interface NotificationPrefs {
  email: boolean;
  push: boolean;
  thresholds: {
    soilMoistureLow: number;  // e.g. %, 0..100
    tempHigh: number;         // °C, e.g. 5..45
  };
}
```

---

## Scope (frontend)
- Add `src/features/notifications/api.ts` with:
  - `getNotificationPrefs()` → GET `/api/notifications`
  - `updateNotificationPrefs(prefs)` → PUT `/api/notifications`
  - Use the common `{ ok, data }` envelope.
- Create `src/features/notifications/NotificationsPage.tsx`:
  - On mount → load prefs; show Spinner while loading; Alert on error.
  - Form fields:
    - `ToggleSwitch` for **Email alerts**
    - `ToggleSwitch` for **Push alerts** (no actual push wiring yet)
    - `TextInput` (`type="number"`) for **Soil moisture low** (min 0, max 100)
    - `TextInput` (`type="number"`) for **Temperature high** (°C; sensible range like 5..45)
  - Buttons: **Save** (primary), **Reset** (light). Show success Alert on save.
  - Disable Save while request is in-flight.
- Wire route and nav:
  - Add `/notifications` to router.
  - Add a Sidebar item “Notifications” (icon optional).
- Keep diffs small; do not touch backend or unrelated features.

---

## File changes
```
src/
  features/
    notifications/
      api.ts                   # NEW — GET/PUT helpers
      NotificationsPage.tsx    # NEW — UI
  app/
    routes.tsx                 # UPDATE — add route for /notifications
  app/
    App.tsx / Sidebar          # UPDATE — add Nav item (if not present)
```

### `src/features/notifications/api.ts` (sketch)
```ts
import { api } from '@/shared/hooks/useApi';

export interface NotificationPrefs {
  email: boolean;
  push: boolean;
  thresholds: { soilMoistureLow: number; tempHigh: number };
}
type Envelope<T> = { ok: true; data: T } | { ok: false; error: { code: string; message: string } };

export async function getNotificationPrefs(): Promise<NotificationPrefs> {
  const { data } = await api.get<Envelope<NotificationPrefs>>('/notifications');
  if (!('ok' in data) || !data.ok) throw new Error('Failed to load notifications');
  return data.data;
}

export async function updateNotificationPrefs(prefs: NotificationPrefs): Promise<NotificationPrefs> {
  const { data } = await api.put<Envelope<NotificationPrefs>>('/notifications', prefs);
  if (!('ok' in data) || !data.ok) throw new Error('Failed to save notifications');
  return data.data;
}
```

### `src/features/notifications/NotificationsPage.tsx` (sketch)
```tsx
import { useEffect, useState } from 'react';
import { Card, Spinner, Alert, Button, Label, TextInput, ToggleSwitch } from 'flowbite-react';
import { getNotificationPrefs, updateNotificationPrefs, NotificationPrefs } from './api';

export default function NotificationsPage() {
  const [prefs, setPrefs] = useState<NotificationPrefs | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [saved, setSaved] = useState(false);

  useEffect(() => {
    let alive = true;
    (async () => {
      try {
        const p = await getNotificationPrefs();
        if (alive) setPrefs(p);
      } catch (e: any) {
        if (alive) setError(e.message || 'Failed to load');
      } finally {
        if (alive) setLoading(false);
      }
    })();
    return () => { alive = false; };
  }, []);

  const clamp = (n: number, min: number, max: number) => Math.max(min, Math.min(max, n));

  if (loading) return <div className="min-h-[60vh] flex items-center justify-center"><Spinner size="xl" /></div>;
  if (error) return <div className="p-4"><Alert color="failure">{error}</Alert></div>;

  return (
    <div className="p-4">
      {saved && <div className="mb-4"><Alert color="success">Notification preferences saved.</Alert></div>}
      <Card className="max-w-2xl">
        <div className="grid gap-4">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-medium">Email alerts</div>
              <div className="text-sm text-gray-500">Receive important alerts via email.</div>
            </div>
            <ToggleSwitch checked={prefs!.email} onChange={(v) => setPrefs({ ...prefs!, email: v })} />
          </div>

          <div className="flex items-center justify-between">
            <div>
              <div className="font-medium">Push alerts</div>
              <div className="text-sm text-gray-500">Browser/device push notifications (coming later).</div>
            </div>
            <ToggleSwitch checked={prefs!.push} onChange={(v) => setPrefs({ ...prefs!, push: v })} />
          </div>

          <div>
            <Label htmlFor="soil" value="Soil moisture low threshold (%)" />
            <TextInput id="soil" type="number" min={0} max={100}
              value={prefs!.thresholds.soilMoistureLow}
              onChange={(e) => setPrefs({
                ...prefs!,
                thresholds: { ...prefs!.thresholds, soilMoistureLow: clamp(Number(e.target.value) || 0, 0, 100) }
              })} />
          </div>

          <div>
            <Label htmlFor="temp" value="Temperature high threshold (°C)" />
            <TextInput id="temp" type="number" min={5} max={45}
              value={prefs!.thresholds.tempHigh}
              onChange={(e) => setPrefs({
                ...prefs!,
                thresholds: { ...prefs!.thresholds, tempHigh: clamp(Number(e.target.value) || 0, 5, 45) }
              })} />
          </div>

          <div className="flex gap-3">
            <Button isProcessing={saving} onClick={async () => {
              try {
                setSaving(true);
                setSaved(false);
                await updateNotificationPrefs(prefs!);
                setSaved(true);
              } catch (e: any) {
                setError(e.message || 'Save failed');
              } finally {
                setSaving(false);
              }
            }}>Save</Button>
            <Button color="light" onClick={() => window.location.reload()}>Reset</Button>
          </div>
        </div>
      </Card>
    </div>
  );
}
```

### Router & Nav (sketch)
```tsx
// routes.tsx
{ path: '/notifications', element: <NotificationsPage /> }

// Sidebar: add link to /notifications if not present
```

---

## UX notes
- Validate numeric inputs on change and on submit; clamp values to ranges.
- Keep layout responsive and accessible (labels linked to inputs).
- Keep visual consistency with Dashboard/Settings (container width, spacing, cards).

---

## Acceptance
- Visiting `/notifications` loads current prefs via GET, shows Spinner then form.
- Editing fields and clicking **Save** performs PUT; on success shows success Alert.
- Reloading the page preserves the saved prefs (in-memory per `uid` on backend).
- Error conditions show a clear Alert and do not leave the UI in undefined state.

---

## Notes for agents
- Keep changes limited to `features/notifications` and router/nav files.
- Prefer Flowbite components; avoid custom CSS beyond Tailwind utilities.
- No new dependencies; if you need tiny helpers, add them locally inside the feature.
