# TG-016 — Frontend Alerts panel + toasts (consume `/api/alerts`)

**Goal**  
Surface backend alerts in the UI: a global toast notifier for **new** alerts and dedicated screens/panels to view, acknowledge, and review history. Poll the backend periodically; no new deps.

> Follow `frontend/AGENTS.md` (Flowbite-first UI, full-height layout, responsive). Keep diffs small and contained in the alerts feature + minimal app wiring.

---

## Backend contract (from TG-015)
- `GET /api/alerts` → `{ ok, data: { items: Alert[], total } }` — active alerts.
- `GET /api/alerts/history?limit=100` → `{ ok, data: { items: Alert[], total } }` — recent history.
- `POST /api/alerts/:id/ack` → `{ ok, data: { id } }` — acknowledge active alert.

**Alert (TS)**
```ts
export type AlertType = 'SOIL_MOISTURE_LOW' | 'TEMP_HIGH' | 'SENSOR_STALE';
export type AlertSeverity = 'info' | 'warn' | 'critical';
export interface Alert {
  id: string;
  type: AlertType;
  severity: AlertSeverity;
  message: string;
  startedAt: string;                 // ISO
  resolvedAt?: string;
  acknowledged: boolean;
  sensor?: string;
  value?: number;
  threshold?: number;
}
```

---

## Scope (frontend)
1) **API helpers** (`src/features/alerts/api.ts`):
   - `getActiveAlerts()` → GET `/api/alerts`
   - `getAlertHistory(limit = 100)` → GET `/api/alerts/history`
   - `ackAlert(id: string)` → POST `/api/alerts/:id/ack`

2) **Global Alerts Provider** (`src/features/alerts/AlertsProvider.tsx`):
   - Poll `getActiveAlerts()` every **30s** (configurable).
   - Keep `seenIds` in a `useRef<Set<string>>`. For any **new** active alert not in `seenIds`, push a toast.
   - Expose `useAlerts()` hook returning `{ active, refresh, lastFetchedAt }`.
   - Render a bottom-right Toast stack using Flowbite `<Toast>`.

3) **Dashboard panel** (`src/features/alerts/AlertPanel.tsx`):
   - A small `Card` listing active alerts (type, message, startedAt, severity badge) + **Acknowledge** button.
   - Empty state if none. Link to **/alerts**.

4) **Alerts page** (`src/features/alerts/AlertsPage.tsx`):
   - Tabs or two `Card`s: **Active** and **History**.
   - Active: table of current alerts with Ack buttons.
   - History: table of recent alerts (limit select: 50/100/200); no Ack.
   - Show severity via `Badge` color: info→`info`, warn→`warning`, critical→`failure`.

5) **Wiring**:
   - Add provider to `src/app/providers.tsx` (wrap App shell).
   - Add route `/alerts` and a Sidebar nav item **Alerts** with a **Badge** showing the active count.

_No new dependencies._

---

## File changes
```
src/
  features/
    alerts/
      api.ts                 # NEW — HTTP helpers
      AlertsProvider.tsx     # NEW — global polling + toasts + hook
      AlertPanel.tsx         # NEW — small dashboard card
      AlertsPage.tsx         # NEW — full page (active + history)
  app/
    providers.tsx            # UPDATE — wrap with <AlertsProvider>
    routes.tsx               # UPDATE — add { path: '/alerts', element: <AlertsPage /> }
    App.tsx (Sidebar)        # UPDATE — add nav with count badge
```

---

## Sketches

### `src/features/alerts/api.ts`
```ts
import { api } from '@/shared/hooks/useApi';

export type AlertType = 'SOIL_MOISTURE_LOW' | 'TEMP_HIGH' | 'SENSOR_STALE';
export type AlertSeverity = 'info' | 'warn' | 'critical';
export interface Alert {
  id: string;
  type: AlertType;
  severity: AlertSeverity;
  message: string;
  startedAt: string;
  resolvedAt?: string;
  acknowledged: boolean;
  sensor?: string;
  value?: number;
  threshold?: number;
}

type Envelope<T> = { ok: true; data: T } | { ok: false; error: { code: string; message: string } };

export async function getActiveAlerts(): Promise<Alert[]> {
  const { data } = await api.get<Envelope<{ items: Alert[]; total: number }>>('/alerts');
  if (!('ok' in data) || !data.ok) throw new Error('Failed to load alerts');
  return data.data.items;
}

export async function getAlertHistory(limit = 100): Promise<Alert[]> {
  const { data } = await api.get<Envelope<{ items: Alert[]; total: number }>>('/alerts/history', { params: { limit } });
  if (!('ok' in data) || !data.ok) throw new Error('Failed to load alert history');
  return data.data.items;
}

export async function ackAlert(id: string): Promise<void> {
  const { data } = await api.post<Envelope<{ id: string }>>(`/alerts/${id}/ack`, {});
  if (!('ok' in data) || !data.ok) throw new Error('Failed to acknowledge alert');
}
```

### `src/features/alerts/AlertsProvider.tsx`
```tsx
import { createContext, useContext, useEffect, useMemo, useRef, useState } from 'react';
import { Toast, Badge, Button } from 'flowbite-react';
import { getActiveAlerts, Alert, ackAlert } from './api';

type Ctx = {
  active: Alert[];
  refresh: () => Promise<void>;
  lastFetchedAt?: number;
};
const AlertsCtx = createContext<Ctx>({ active: [], refresh: async () => {} });

export function AlertsProvider({ children, intervalMs = 30000 }: { children: React.ReactNode; intervalMs?: number }) {
  const [active, setActive] = useState<Alert[]>([]);
  const [toasts, setToasts] = useState<Alert[]>([]);
  const seen = useRef<Set<string>>(new Set());
  const [lastFetchedAt, setLastFetchedAt] = useState<number>();

  async function refresh() {
    const items = await getActiveAlerts();
    setActive(items);
    setLastFetchedAt(Date.now());
    // new ones → toast
    const newOnes = items.filter(a => !seen.current.has(a.id));
    if (newOnes.length) {
      setToasts(t => [...newOnes, ...t].slice(0, 4));
      newOnes.forEach(a => seen.current.add(a.id));
    }
  }

  useEffect(() => {
    refresh().catch(() => {});
    const id = window.setInterval(() => { refresh().catch(() => {}); }, intervalMs);
    return () => window.clearInterval(id);
  }, [intervalMs]);

  return (
    <AlertsCtx.Provider value={{ active, refresh, lastFetchedAt }}>
      {children}
      {/* Toast stack */}
      <div className="fixed bottom-4 right-4 z-50 space-y-2 w-80">
        {toasts.map(t => (
          <Toast key={t.id}>
            <div className="text-sm">
              <div className="flex items-center gap-2">
                <Badge color={t.severity === 'critical' ? 'failure' : t.severity === 'warn' ? 'warning' : 'info'}>{t.severity}</Badge>
                <span className="font-medium">{t.type.replaceAll('_',' ')}</span>
              </div>
              <div className="mt-1">{t.message}</div>
            </div>
            <Toast.Toggle onDismiss={() => setToasts(curr => curr.filter(x => x.id !== t.id))} />
          </Toast>
        ))}
      </div>
    </AlertsCtx.Provider>
  );
}

export function useAlerts() {
  return useContext(AlertsCtx);
}
```

### `src/features/alerts/AlertPanel.tsx`
```tsx
import { Card, Badge, Button } from 'flowbite-react';
import { useAlerts } from './AlertsProvider';
import { ackAlert } from './api';
import { Link } from 'react-router-dom';

export function AlertPanel() {
  const { active, refresh } = useAlerts();
  if (!active.length) {
    return (
      <Card>
        <div className="flex items-center justify-between">
          <div className="text-sm text-gray-500">Alerts</div>
          <Link to="/alerts" className="text-sm underline">View all</Link>
        </div>
        <div className="text-sm text-gray-600">No active alerts.</div>
      </Card>
    );
  }

  return (
    <Card>
      <div className="flex items-center justify-between">
        <div className="text-sm text-gray-500">Alerts</div>
        <Link to="/alerts" className="text-sm underline">View all</Link>
      </div>
      <div className="space-y-2">
        {active.map(a => (
          <div key={a.id} className="flex items-center justify-between">
            <div>
              <div className="font-medium">{a.type.replaceAll('_',' ')}</div>
              <div className="text-sm text-gray-600">{a.message}</div>
            </div>
            <div className="flex items-center gap-2">
              <Badge color={a.severity === 'critical' ? 'failure' : a.severity === 'warn' ? 'warning' : 'info'}>{a.severity}</Badge>
              {!a.acknowledged && (
                <Button size="xs" onClick={async () => { await ackAlert(a.id); await refresh(); }}>Ack</Button>
              )}
            </div>
          </div>
        ))}
      </div>
    </Card>
  );
}
```

### `src/features/alerts/AlertsPage.tsx`
```tsx
import { useEffect, useState } from 'react';
import { Alert as FbAlert, Badge, Button, Card, Select, Spinner, Table } from 'flowbite-react';
import { getAlertHistory } from './api';
import { useAlerts } from './AlertsProvider';
import type { Alert } from './api';

export default function AlertsPage() {
  const { active, refresh } = useAlerts();
  const [hist, setHist] = useState<Alert[]>([]);
  const [limit, setLimit] = useState(100);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  async function loadHistory() {
    setLoading(true); setError(null);
    try { setHist(await getAlertHistory(limit)); }
    catch (e: any) { setError(e.message || 'Failed to load history'); }
    finally { setLoading(false); }
  }

  useEffect(() => { loadHistory(); /* eslint-disable-next-line */ }, [limit]);

  return (
    <div className="p-4 space-y-4">
      <Card>
        <div className="mb-2 text-lg font-semibold">Active alerts</div>
        {!active.length ? (
          <FbAlert color="info">No active alerts.</FbAlert>
        ) : (
          <Table>
            <Table.Head>
              <Table.HeadCell>Type</Table.HeadCell>
              <Table.HeadCell>Message</Table.HeadCell>
              <Table.HeadCell>Severity</Table.HeadCell>
              <Table.HeadCell>Started</Table.HeadCell>
              <Table.HeadCell>Ack</Table.HeadCell>
            </Table.Head>
            <Table.Body className="divide-y">
              {active.map(a => (
                <Table.Row key={a.id}>
                  <Table.Cell className="font-medium">{a.type.replaceAll('_',' ')}</Table.Cell>
                  <Table.Cell>{a.message}</Table.Cell>
                  <Table.Cell><Badge color={a.severity === 'critical' ? 'failure' : a.severity === 'warn' ? 'warning' : 'info'}>{a.severity}</Badge></Table.Cell>
                  <Table.Cell>{new Date(a.startedAt).toLocaleString()}</Table.Cell>
                  <Table.Cell><Button size="xs" onClick={refresh}>Ack (on panel)</Button></Table.Cell>
                </Table.Row>
              ))}
            </Table.Body>
          </Table>
        )}
      </Card>

      <Card>
        <div className="mb-2 flex items-center justify-between">
          <div className="text-lg font-semibold">History</div>
          <div className="flex items-center gap-2">
            <span className="text-sm text-gray-500">Limit</span>
            <Select value={limit} onChange={(e) => setLimit(Number(e.target.value))}>
              <option value={50}>50</option>
              <option value={100}>100</option>
              <option value={200}>200</option>
            </Select>
            <Button color="light" onClick={loadHistory}>Refresh</Button>
          </div>
        </div>
        {loading ? (
          <div className="min-h-[20vh] flex items-center justify-center"><Spinner /></div>
        ) : error ? (
          <FbAlert color="failure">{error}</FbAlert>
        ) : !hist.length ? (
          <FbAlert color="info">No history yet.</FbAlert>
        ) : (
          <div className="overflow-x-auto">
            <Table>
              <Table.Head>
                <Table.HeadCell>Type</Table.HeadCell>
                <Table.HeadCell>Message</Table.HeadCell>
                <Table.HeadCell>Severity</Table.HeadCell>
                <Table.HeadCell>Started</Table.HeadCell>
                <Table.HeadCell>Resolved</Table.HeadCell>
              </Table.Head>
              <Table.Body className="divide-y">
                {hist.map(a => (
                  <Table.Row key={a.id}>
                    <Table.Cell className="font-medium">{a.type.replaceAll('_',' ')}</Table.Cell>
                    <Table.Cell>{a.message}</Table.Cell>
                    <Table.Cell><Badge color={a.severity === 'critical' ? 'failure' : a.severity === 'warn' ? 'warning' : 'info'}>{a.severity}</Badge></Table.Cell>
                    <Table.Cell>{new Date(a.startedAt).toLocaleString()}</Table.Cell>
                    <Table.Cell>{a.resolvedAt ? new Date(a.resolvedAt).toLocaleString() : '—'}</Table.Cell>
                  </Table.Row>
                ))}
              </Table.Body>
            </Table>
          </div>
        )}
      </Card>
    </div>
  );
}
```

### App wiring (sketch)
```tsx
// providers.tsx
import { AlertsProvider } from '@/features/alerts/AlertsProvider';
export function AppProviders({ children }: { children: React.ReactNode }) {
  return (
    <ThemeProvider>
      <QueryClientProvider client={client}>
        <AlertsProvider>{children}</AlertsProvider>
      </QueryClientProvider>
    </ThemeProvider>
  );
}

// routes.tsx
{ path: '/alerts', element: <AlertsPage /> }

// Sidebar (show count)
import { useAlerts } from '@/features/alerts/AlertsProvider';
// inside Sidebar item render:
const { active } = useAlerts();
// render a small count badge next to "Alerts"
```

---

## UX notes
- Toasts should not flood: cap stack to ~4 and dismiss oldest when adding new.
- Severity coloring: info→blue, warn→amber, critical→red (Flowbite `info`/`warning`/`failure`).
- Keyboard and screen-reader friendly (buttons labelled, links clear).

---

## Acceptance
- Global polling every ~30s shows toast notifications only for **new** active alerts (not previously seen in this session).
- `/alerts` page lists active alerts and separate history with limit control.
- The Dashboard shows a compact **AlertPanel**; Ack action works and refreshes state.
- Sidebar displays an **Alerts** item with a count badge equal to the active alerts length.
- No new runtime dependencies; code changes are limited to the alerts feature + minimal app wiring.
